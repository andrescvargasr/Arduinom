<!doctype html>
<html>
<head>
    <script src='/socket-io.js'></script>
    <script src='/app.js'></script>
    <script>
        var socket = io.connect('http://localhost:3000');
        var devices = {};
        window.devices=devices;

        var a = window.arduinom(socket);
        a.on('newDevice', device => {
            console.log('new device', device);
            connectDevice(device);
            device.on('connect', () => connectDevice(device) );
            device.on('disconnect', () => disconnectDevice(device) );
        });
        // Start to receive event! Don't forget to add that!!
        a.ready();

        function connectDevice(device) {
            devices[device.id]=device;
            console.log('device connected')
        }

        function disconnectDevice(device) {
            console.log('device disconnected')
        }

    </script>


    <script>
        /**
         * Updating every 10s the values in the field info of the device
         */
        async function getDevicesInfo() {
            for (var key of Object.keys(devices)) {
                var device = devices[key];
                device.info = await device.getCurrentDeviceInformation()
            }
        }
        window.setInterval( getDevicesInfo, 10000);


        /**
         * We maintain the last 1000 entries in browser
         */
        async function updateDevicesLogs() {
            for (var key of Object.keys(devices)) {
                var device = devices[key];
                if (!device.logs) device.logs=[];

                var logs = await fetch('/db/'+device.id+'/entries?limit=500&sort=500');
                console.log(logs);

            }
        }
        window.setInterval( updateDevicesLogs, 10000);



    </script>


</head>
<body>
Hello
<ul id='messages'/>
</body>
</html>
